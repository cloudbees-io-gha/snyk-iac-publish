= Snyk IaC scan and publish to Platform

Use this action to scan Infrastructure as Code (IaC) repositories for security vulnerabilities and misconfigurations with the Snyk IaC scanner.
The action output can be used as a quality gate in subsequent GitHub Actions steps or jobs.

Snyk Infrastructure as Code (IaC) is a developer-first security solution that scans and monitors Infrastructure as Code files for security issues and cloud misconfigurations.

Add a Snyk IaC scan to your workflows in CloudBees platform to:

* Detect security vulnerabilities and misconfigurations in IaC files before deployment.
* Identify potential security issues in Terraform, CloudFormation, Kubernetes, Azure Resource Manager, and other IaC frameworks.
* Gain insight into infrastructure security risks and how to fix issues.
* Ensure compliance with security best practices and industry standards.
* Shift security left by catching issues early in the development lifecycle.

CloudBees platform enables you to run a Snyk IaC scan either implicitly or explicitly.

== Explicit and implicit scan types

An implicit scan is automatically triggered, and an explicit scan is one you configure to be invoked in a step of your workflow.
To learn more about the differences between explicit and implicit scans, refer to link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/actions#security[Security scan actions].

To set up implicit scanning, refer to link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/aspm/implicit-security-analysis[Code and binary security analysis].

== Prerequisites

Set up the CloudBees platform and GHA to work together, providing key features of the platform to GHA workflows. Refer to link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/github-actions/gha-getting-started[Getting started with GHA integration] for more information.

== How the scanner works

The Snyk IaC scanner architectural components are:

* Snyk CLI: The command-line interface that performs the scanning.
* Snyk Policy Engine: Evaluates IaC files against security rules and best practices.
* Snyk Cloud Context: Provides additional context about cloud resources and configurations.
* Snyk API: Communicates scan results to the Snyk platform for centralized management.

The scanning process is as follows:

. The Snyk IaC scanner identifies Infrastructure as Code files in your repository.
. IaC files are parsed and analyzed against Snyk's security rules database.
. Security vulnerabilities and misconfigurations are identified based on cloud provider best practices and compliance frameworks.
. Results are reported with severity levels, detailed descriptions, and remediation guidance.
. The scan results are uploaded to the Snyk platform (if configured).
. Results are made available as actionable outputs for quality gates and downstream workflow steps.

NOTE: For more information about Snyk IaC, refer to the link:https://docs.snyk.io/products/snyk-infrastructure-as-code[Snyk IaC documentation].

== Inputs

[cols="2a,1a,1a,3a",options="header"]
.Input details
|===

| Input name
| Data type
| Required?
| Description

| `snyk-token`
| String
| Yes
| The Snyk API token for authentication.

| `org-id`
| String
| Yes
| The Snyk organization ID.

| `severity-threshold`
| String
| No
| Report only vulnerabilities of provided level or higher (low, medium, high, critical).

| `ref`
| String
| No
| Specify the ref to be checked out and scanned.

| `workspace-dir`
| String
| No
| The file path of the code to be scanned.

|===

== Outputs

[cols="2a,1a,4a",options="header"]
.Output details
|===

| Output name
| Data type
| Description

| `critical-count`
| String
| The number of *Critical* severity issues discovered during the scan.

| `very-high-count`
| String
| The number of *Very High* severity issues discovered during the scan.

| `high-count`
| String
| The number of *High* severity issues discovered during the scan.

| `medium-count`
| String
| The number of *Medium* severity issues discovered during the scan.

| `low-count`
| String
| The number of *Low* severity issues discovered during the scan.

|===

IMPORTANT: This action uses GitHub OIDC authentication to securely communicate with CloudBees platform.
Be sure to set permissions to `id-token: write` in your workflow.

== Usage examples

The following is a basic example of using this action:

[source,yaml]
----
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Scan with Snyk IaC
        uses: cloudbees-io-gha/snyk-iac-publish@v1
        with:
          snyk-token: ${{ secrets.SNYK_TOKEN }}
          org-id: ${{ vars.SNYK_ORG_ID }}

----

=== Using severity threshold

In the following example, the scan will only report issues of high or critical severity:

[source,yaml]
----
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Scan with Snyk IaC with severity threshold
        uses: cloudbees-io-gha/snyk-iac-publish@v1
        with:
          snyk-token: ${{ secrets.SNYK_TOKEN }}
          org-id: ${{ vars.SNYK_ORG_ID }}
          severity-threshold: 'high'

----

=== Using the action output

You can use the output values from this action in downstream steps and jobs.
The following example uses the action output in a downstream step of the same job:

[source, yaml,role="default-expanded"]
----
name: my-workflow

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  snyk-iac-scan-job:
    runs-on: ubuntu-latest
    steps:
      - name: Check out source code
        uses: actions/checkout@v2

      - id: snyk-iac-step
        name: Snyk IaC Scan
        uses: cloudbees-io-gha/snyk-iac-publish@v1
        with:
          snyk-token: ${{ secrets.SNYK_TOKEN }}
          org-id: ${{ vars.SNYK_ORG_ID }}

      - name: Source dir examine
        run: |
          docker run --rm -v "${{ github.workspace }}:/work" -w /work golang:1.20.3-alpine3.17 ls -latR /work

      - id: print-outputs-from-snyk-iac-step
        name: Print outputs from the upstream Snyk IaC Scan step
        run: |
          # Printing all outputs
          echo "Outputs from upstream Snyk IaC Scan step:"
          echo "Critical count: ${{ steps.snyk-iac-step.outputs.critical-count }}"
          echo "Very high count: ${{ steps.snyk-iac-step.outputs.very-high-count }}"
          echo "High count: ${{ steps.snyk-iac-step.outputs.high-count }}"
          echo "Medium count: ${{ steps.snyk-iac-step.outputs.medium-count }}"
          echo "Low count: ${{ steps.snyk-iac-step.outputs.low-count }}"
----

The following example uses the action output in a downstream job:

[source, yaml,role="default-expanded"]
----
name: my-workflow

on:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  job1:
    runs-on: ubuntu-latest
    outputs:
      snyk-iac-job-output-critical: ${{ steps.snyk-iac-step.outputs.critical-count }}
      snyk-iac-job-output-very-high: ${{ steps.snyk-iac-step.outputs.very-high-count }}
      snyk-iac-job-output-high: ${{ steps.snyk-iac-step.outputs.high-count }}
      snyk-iac-job-output-medium: ${{ steps.snyk-iac-step.outputs.medium-count }}
      snyk-iac-job-output-low: ${{ steps.snyk-iac-step.outputs.low-count }}
    steps:
      - name: Check out source code
        uses: actions/checkout@v2

      - id: snyk-iac-step
        name: Snyk IaC scan
        uses: cloudbees-io-gha/snyk-iac-publish@v1
        with:
          snyk-token: ${{ secrets.SNYK_TOKEN }}
          org-id: ${{ vars.SNYK_ORG_ID }}
          severity-threshold: 'high'

      - name: Source dir examine
        run: |
          ls -latR ${GITHUB_WORKSPACE}

  job2:
    runs-on: ubuntu-latest
    needs: job1
    steps:
      - id: print-outputs-from-job1
        name: Print outputs from upstream job1
        run: |
          # Printing all outputs
          echo "Outputs from upstream Snyk IaC Scan job:"
          echo "Critical count: ${{ needs.job1.outputs.snyk-iac-job-output-critical }}"
          echo "Very high count: ${{ needs.job1.outputs.snyk-iac-job-output-very-high }}"
          echo "High count: ${{ needs.job1.outputs.snyk-iac-job-output-high }}"
          echo "Medium count: ${{ needs.job1.outputs.snyk-iac-job-output-medium }}"
          echo "Low count: ${{ needs.job1.outputs.snyk-iac-job-output-low }}"
----

=== Full workflow and run example

The following GHA workflow example scans a Terraform repository with Snyk IaC scanner.

.Example GHA workflow YAML file
[.collapsible]
--

[source, yaml,role="default-expanded"]
----
name: Snyk IaC scan

on:
  push:
    branches:
     - main

permissions:
  id-token: write
  contents: read

jobs:
  snyk-iac-scan:
    runs-on:
     ubuntu-latest
    outputs:
      snyk-iac-job-output-critical: ${{ steps.snyk-iac-step.outputs.critical-count }}
      snyk-iac-job-output-very-high: ${{ steps.snyk-iac-step.outputs.very-high-count }}
      snyk-iac-job-output-high: ${{ steps.snyk-iac-step.outputs.high-count }}
      snyk-iac-job-output-medium: ${{ steps.snyk-iac-step.outputs.medium-count }}
      snyk-iac-job-output-low: ${{ steps.snyk-iac-step.outputs.low-count }}
    steps:

      # Checkout code
      - name: Checkout repository code
        uses: actions/checkout@v4

      # Print run info
      - name: Print run info
        shell: bash
        run: |
          echo "Ref name is $GITHUB_RUN_ID"
          echo "Source is ${{ github.server_url }}/${{ github.repository }}"
          echo "Subject is $GITHUB_WORKFLOW_REF|${{ github.run_id }}|${{ github.run_attempt }}|${{ github.run_number }}"
          echo "Job is $GITHUB_JOB"

      # Run Snyk IaC scan
      - name: Snyk IaC scan
        id: snyk-iac-step
        uses: cloudbees-io-gha/snyk-iac-publish@v1
        with:
          snyk-token: ${{ secrets.SNYK_TOKEN }}
          org-id: ${{ vars.SNYK_ORG_ID }}
          severity-threshold: 'medium'

      - name: Source dir examine
        run: |
          docker run --rm -v "${{ github.workspace }}:/work" -w /work golang:1.20.3-alpine3.17 ls -latR /work

      - id: print-outputs-from-snyk-iac-step
        name: Print outputs from the upstream Snyk IaC Scan step
        run: |
          # Printing all outputs
          echo "Outputs from upstream Snyk IaC Scan step:"
          echo "Critical count: ${{ steps.snyk-iac-step.outputs.critical-count }}"
          echo "Very high count: ${{ steps.snyk-iac-step.outputs.very-high-count }}"
          echo "High count: ${{ steps.snyk-iac-step.outputs.high-count }}"
          echo "Medium count: ${{ steps.snyk-iac-step.outputs.medium-count }}"
          echo "Low count: ${{ steps.snyk-iac-step.outputs.low-count }}"

----
--

After the GHA run has completed, the security findings are collected and displayed in the link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/aspm/security-center[Security center] of the component containing the workflow.

=== Scan Kubernetes manifests with Snyk IaC

The following GHA workflow example scans Kubernetes manifests with Snyk IaC.

[source, yaml,role="default-expanded"]
----
name: Snyk IaC scan

on:
  push:
    branches:
     - main

permissions:
  id-token: write
  contents: read

jobs:
  snyk-iac-k8s-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Kubernetes manifest source code
        uses: actions/checkout@v4

      - name: Snyk IaC scan on Kubernetes manifests
        uses: cloudbees-io-gha/snyk-iac-publish@v1
        with:
          snyk-token: ${{ secrets.SNYK_TOKEN }}
          org-id: ${{ vars.SNYK_ORG_ID }}
          severity-threshold: 'medium'

----

=== Scan AWS CloudFormation templates with Snyk IaC

The following GHA workflow example scans AWS CloudFormation templates with Snyk IaC.

[source, yaml,role="default-expanded"]
----
name: Snyk IaC scan

on:
  push:
    branches:
     - main

permissions:
  id-token: write
  contents: read

jobs:
  snyk-iac-cloudformation-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Check out CloudFormation templates
        uses: actions/checkout@v4

      - name: Snyk IaC scan on CloudFormation templates
        uses: cloudbees-io-gha/snyk-iac-publish@v1
        with:
          snyk-token: ${{ secrets.SNYK_TOKEN }}
          org-id: ${{ vars.SNYK_ORG_ID }}

----

== License

This code is made available under the
link:https://opensource.org/license/mit/[MIT license].

== References

* Learn more about link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/github-actions/intro[Using GitHub Actions with CloudBees platform].
* Learn about link:https://docs.cloudbees.com/docs/cloudbees-platform/latest/[CloudBees platform].
* Learn about link:https://docs.snyk.io/products/snyk-infrastructure-as-code[Snyk Infrastructure as Code].




